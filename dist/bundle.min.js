(()=>{"use strict";class t extends HTMLElement{constructor(){super(),this.initialGain=1,this.attachShadow({mode:"open"})}connectedCallback(){const t=this.getAttribute("value");null!==t&&(this.initialGain=parseFloat(t)),this.render(),this.setupEventListeners()}render(){const e=this.getAttribute("name")||"Track",i=this.gainToSliderValue(this.initialGain),s=this.gainToDb(this.initialGain);this.shadowRoot.innerHTML=`\n      <style>\n        .fader {\n          display: flex;\n          flex-direction: column;\n          align-items: center;\n          width: 60px;\n          height: 220px;\n          background: #2c3e50;\n          border-radius: 10px;\n          padding: 10px 0;\n          box-sizing: border-box;\n          position: relative;\n        }\n        .slider-container {\n          position: relative;\n          height: 150px;\n          width: 40px;\n          background: #34495e;\n          border-radius: 20px;\n          display: flex;\n          justify-content: center;\n          align-items: center;\n          padding: 10px 0;\n        }\n        input[type="range"] {\n          writing-mode: bt-lr;\n          -webkit-appearance: none;\n          width: 200px;\n          height: 10px;\n          background: transparent;\n          transform: rotate(-90deg);\n          z-index: 2;\n        }\n        input[type="range"]::-webkit-slider-thumb {\n          -webkit-appearance: none;\n          width: 20px;\n          height: 40px;\n          background: #3498db;\n          cursor: pointer;\n          border-radius: 4px;\n          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n        }\n        .scale {\n          position: absolute;\n          left: 45px;\n          top: 10px;\n          height: 150px;\n          width: 20px;\n          color: #bdc3c7;\n          font-size: 10px;\n        }\n        .scale span {\n          position: absolute;\n          left: 0;\n          transform: translateY(50%);\n        }\n        label {\n          margin-top: 10px;\n          text-align: center;\n          color: #ecf0f1;\n          font-size: 12px;\n          font-weight: bold;\n        }\n        .value-display {\n          margin-top: 5px;\n          color: #3498db;\n          font-size: 14px;\n        }\n      </style>\n      <div class="fader">\n        <div class="slider-container">\n          <input type="range" min="0" max="100" step="1" value="${i}">\n          <div class="scale">\n            <span style="bottom: 100%;">14</span>\n            <span style="bottom: 92.86%;">8</span>\n            <span style="bottom: 83.33%;">0</span>\n            <span style="bottom: 71.43%;">-10</span>\n            <span style="bottom: 59.52%;">-20</span>\n            <span style="bottom: 0%;">-∞</span>\n          </div>\n        </div>\n        <label>${e}</label>\n        <span class="value-display">${s<=t.MIN_DB+.1?"-∞":s.toFixed(1)} dB</span>\n      </div>\n    `,this.slider=this.shadowRoot.querySelector("input"),this.valueDisplay=this.shadowRoot.querySelector(".value-display")}setupEventListeners(){this.slider.addEventListener("input",(t=>{const e=t.target,i=parseInt(e.value),s=this.sliderValueToGain(i),n=this.gainToDb(s);this.updateValueDisplay(n),this.dispatchEvent(new CustomEvent("change",{detail:{value:s},bubbles:!0,composed:!0}))}))}setDisabled(t){this.slider.disabled=t}setValue(t){const e=this.gainToSliderValue(t);this.slider.value=e.toString(),this.updateValueDisplay(this.gainToDb(t))}gainToSliderValue(e){if(e<=0)return 0;{const i=(this.gainToDb(e)-t.MIN_DB)/(t.MAX_DB-t.MIN_DB)*100;return Math.round(i)}}sliderValueToGain(e){if(e<=0)return 0;{const i=e/100*(t.MAX_DB-t.MIN_DB)+t.MIN_DB;return this.dbToGain(i)}}updateValueDisplay(e){e<=t.MIN_DB+.1||!isFinite(e)?this.valueDisplay.textContent="-∞ dB":this.valueDisplay.textContent=`${e.toFixed(1)} dB`}gainToDb(t){return t<=0?-1/0:20*Math.log10(t)}dbToGain(t){return Math.pow(10,t/20)}}t.MIN_DB=-70,t.MAX_DB=14,customElements.get("volume-slider")||customElements.define("volume-slider",t);const e=t;var i=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{d(s.next(t))}catch(t){a(t)}}function r(t){try{d(s.throw(t))}catch(t){a(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}d((s=s.apply(t,e||[])).next())}))};new class{constructor(){this.isAudioInitialized=!1,this.isAudioLoaded=!1,this.isAnswerMode=!1,this.playerSettings={vocal:1,guitar:1,piano:1,other:1,bass:1,drum:1},this.isSubmitted=!1,this.isComparisonMode=!1,this.isPlaying=!1,this.startTime=0,this.pauseTime=0,this.tracksBaseUrl="../songs/UpLifeSongs/以斯拉 - 至高全能神的榮光",this.tracks=["vocal","guitar","piano","other","bass","drum"],this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioBuffers={},this.audioSources={},this.gainNodes={},this.analyserNodes={},this.masterGainNode=this.audioContext.createGain(),this.randomGains={},customElements.get("volume-slider")||customElements.define("volume-slider",e),this.initGame()}initAudio(){this.isAudioInitialized||(this.masterGainNode.connect(this.audioContext.destination),this.tracks.forEach((t=>{this.gainNodes[t]=this.audioContext.createGain(),this.analyserNodes[t]=this.audioContext.createAnalyser(),this.gainNodes[t].connect(this.analyserNodes[t]),this.analyserNodes[t].connect(this.masterGainNode),this.randomGains[t]=Math.exp(Math.random()*Math.log(16))/4;const e=document.getElementById(`${t}-fader`);e&&(e.setValue(1),this.setTrackVolume(t,1))})),this.isAudioInitialized=!0)}loadAudio(){return i(this,void 0,void 0,(function*(){const t=document.getElementById("playPauseBtn");t.textContent="載入中",t.disabled=!0;try{yield Promise.all(this.tracks.map((t=>i(this,void 0,void 0,(function*(){const e=yield fetch(`${this.tracksBaseUrl}/${t}.mp3`),i=yield e.arrayBuffer();this.audioBuffers[t]=yield this.audioContext.decodeAudioData(i)}))))),this.isAudioLoaded=!0,t.innerHTML="&#9658;",t.disabled=!1,console.log("所有音軌已成功載入")}catch(e){console.error("載入音頻時發生錯誤:",e),t.textContent="載入失敗",t.disabled=!1}}))}createAudioSources(){this.tracks.forEach((t=>{this.audioSources[t]&&this.audioSources[t].disconnect(),this.audioSources[t]=this.audioContext.createBufferSource(),this.audioSources[t].buffer=this.audioBuffers[t],this.audioSources[t].connect(this.gainNodes[t]),this.audioSources[t].loop=!0}))}togglePlayPause(){if(!this.isAudioInitialized)return this.initAudio(),void this.loadAudio();this.isAudioLoaded&&(this.isPlaying?(this.audioContext.suspend(),this.pauseTime=this.audioContext.currentTime):(this.audioContext.resume(),this.audioSources[this.tracks[0]]&&this.audioSources[this.tracks[0]].buffer?this.startTime+=this.audioContext.currentTime-this.pauseTime:(this.createAudioSources(),this.startTime=this.audioContext.currentTime,this.tracks.forEach((t=>this.audioSources[t].start()))),requestAnimationFrame((()=>this.updateTimeSlider()))),this.isPlaying=!this.isPlaying,document.getElementById("playPauseBtn").innerHTML=this.isPlaying?"&#10074;&#10074;":"&#9658;")}updateTimeSlider(){if(!this.isPlaying)return;const t=(this.audioContext.currentTime-this.startTime)/this.audioBuffers[this.tracks[0]].duration*100;document.getElementById("timeSlider").value=t.toString(),requestAnimationFrame((()=>this.updateTimeSlider()))}setMasterVolume(t){this.isAudioInitialized&&this.masterGainNode.gain.setValueAtTime(t,this.audioContext.currentTime)}setTrackVolume(t,e){this.isAudioInitialized&&this.gainNodes[t].gain.setValueAtTime(e,this.audioContext.currentTime)}setPlaybackPosition(t){if(!this.isAudioInitialized||!this.isAudioLoaded)return;const e=t/100*this.audioBuffers[this.tracks[0]].duration,i=this.isPlaying;this.isPlaying&&this.audioContext.suspend(),this.createAudioSources(),this.startTime=this.audioContext.currentTime-e,this.tracks.forEach((t=>this.audioSources[t].start(0,e))),i&&(this.audioContext.resume(),requestAnimationFrame((()=>this.updateTimeSlider()))),this.isPlaying=i,document.getElementById("playPauseBtn").innerHTML=this.isPlaying?"&#10074;&#10074;":"&#9658;"}calculateScore(){if(!this.isAudioInitialized||!this.isAudioLoaded)return 0;let t=0;this.tracks.forEach((e=>{const i=this.playerSettings[e],s=1/this.randomGains[e],n=Math.abs(Math.log2(i)-Math.log2(s));t+=n}));const e=Math.max(0,100-t/this.tracks.length*25);return Math.round(e)}toggleComparisonMode(t){this.isComparisonMode=t,this.tracks.forEach((e=>{const i=document.getElementById(`${e}-fader`);if(t){const t=1/this.randomGains[e];this.setTrackVolume(e,t),i.setValue(t)}else this.setTrackVolume(e,this.playerSettings[e]),i.setValue(this.playerSettings[e]);i.setDisabled(t)}))}initGame(){document.getElementById("playPauseBtn").addEventListener("click",(()=>this.togglePlayPause())),document.getElementById("timeSlider").addEventListener("input",(t=>this.setPlaybackPosition(parseFloat(t.target.value)))),document.getElementById("master-volume").addEventListener("change",(t=>{const e=t;this.setMasterVolume(e.detail.value)})),this.tracks.forEach((t=>{document.getElementById(`${t}-fader`).addEventListener("change",(e=>{const i=e;if(!this.isAnswerMode){const e=i.detail.value;this.setTrackVolume(t,e),this.playerSettings[t]=e}}))}));const t=document.getElementById("modeToggleCheckbox");t.addEventListener("change",(t=>{this.toggleComparisonMode(t.target.checked)})),document.getElementById("submitBtn").addEventListener("click",(()=>{const e=this.calculateScore(),i=document.getElementById("scoreDisplay");i.style.visibility="visible",i.textContent=e.toString(),document.getElementById("comparisonLabel").textContent="正確答案",this.isSubmitted=!0,t.checked=!1,this.toggleComparisonMode(!1)}))}}})();
//# sourceMappingURL=bundle.min.js.map