(()=>{"use strict";({156:function(){var t=this&&this.__awaiter||function(t,i,e,s){return new(e||(e=Promise))((function(o,a){function n(t){try{d(s.next(t))}catch(t){a(t)}}function r(t){try{d(s.throw(t))}catch(t){a(t)}}function d(t){var i;t.done?o(t.value):(i=t.value,i instanceof e?i:new e((function(t){t(i)}))).then(n,r)}d((s=s.apply(t,i||[])).next())}))};new class{constructor(){this.isAudioInitialized=!1,this.isAudioLoaded=!1,this.isAnswerMode=!1,this.playerSettings={vocal:.5,guitar:.5,piano:.5,other:.5,bass:.5,drum:.5},this.isSubmitted=!1,this.isComparisonMode=!1,this.isPlaying=!1,this.startTime=0,this.pauseTime=0;const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname;this.tracksBaseUrl=t?"../UpLifeSongs/以斯拉 - 至高全能神的榮光":"../../UpLifeSongs/以斯拉 - 至高全能神的榮光",this.tracks=["vocal","guitar","piano","other","bass","drum"],this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioBuffers={},this.audioSources={},this.gainNodes={},this.analyserNodes={},this.masterGainNode=this.audioContext.createGain(),this.randomGains={},this.initGame()}initAudio(){this.isAudioInitialized||(this.masterGainNode.connect(this.audioContext.destination),this.tracks.forEach((t=>{var i;this.gainNodes[t]=this.audioContext.createGain(),this.analyserNodes[t]=this.audioContext.createAnalyser(),this.gainNodes[t].connect(this.analyserNodes[t]),this.analyserNodes[t].connect(this.masterGainNode),this.randomGains[t]=Math.exp(Math.random()*Math.log(4))/2;const e=null===(i=document.getElementById(`${t}-fader`))||void 0===i?void 0:i.querySelector("input");e&&(e.value="0.5",this.setTrackVolume(t,.5))})),this.isAudioInitialized=!0)}loadAudio(){return t(this,void 0,void 0,(function*(){const i=document.getElementById("playPauseBtn");i.textContent="載入中",i.disabled=!0;try{yield Promise.all(this.tracks.map((i=>t(this,void 0,void 0,(function*(){const t=yield fetch(`${this.tracksBaseUrl}/${i}.mp3`),e=yield t.arrayBuffer();this.audioBuffers[i]=yield this.audioContext.decodeAudioData(e)}))))),this.isAudioLoaded=!0,i.innerHTML="&#9658;",i.disabled=!1,console.log("所有音軌已成功載入")}catch(t){console.error("載入音頻時發生錯誤:",t),i.textContent="載入失敗",i.disabled=!1}}))}createAudioSources(){this.tracks.forEach((t=>{this.audioSources[t]&&this.audioSources[t].disconnect(),this.audioSources[t]=this.audioContext.createBufferSource(),this.audioSources[t].buffer=this.audioBuffers[t],this.audioSources[t].connect(this.gainNodes[t]),this.audioSources[t].loop=!0}))}togglePlayPause(){if(!this.isAudioInitialized)return this.initAudio(),void this.loadAudio();this.isAudioLoaded&&(this.isPlaying?(this.audioContext.suspend(),this.pauseTime=this.audioContext.currentTime):(this.audioContext.resume(),this.audioSources[this.tracks[0]]&&this.audioSources[this.tracks[0]].buffer?this.startTime+=this.audioContext.currentTime-this.pauseTime:(this.createAudioSources(),this.startTime=this.audioContext.currentTime,this.tracks.forEach((t=>this.audioSources[t].start()))),requestAnimationFrame((()=>this.updateTimeSlider()))),this.isPlaying=!this.isPlaying,document.getElementById("playPauseBtn").innerHTML=this.isPlaying?"&#10074;&#10074;":"&#9658;")}updateTimeSlider(){if(!this.isPlaying)return;const t=(this.audioContext.currentTime-this.startTime)/this.audioBuffers[this.tracks[0]].duration*100;document.getElementById("timeSlider").value=t.toString(),requestAnimationFrame((()=>this.updateTimeSlider()))}setMasterVolume(t){this.isAudioInitialized&&this.masterGainNode.gain.setValueAtTime(t,this.audioContext.currentTime)}gainToFader(t){return Math.log(t/.25)/Math.log(16)}faderToGain(t){return.25*Math.pow(16,t)}setTrackVolume(t,i){if(!this.isAudioInitialized)return;const e=this.faderToGain(i);this.gainNodes[t].gain.setValueAtTime(e,this.audioContext.currentTime)}setPlaybackPosition(t){if(!this.isAudioInitialized||!this.isAudioLoaded)return;const i=t/100*this.audioBuffers[this.tracks[0]].duration,e=this.isPlaying;this.isPlaying&&this.audioContext.suspend(),this.createAudioSources(),this.startTime=this.audioContext.currentTime-i,this.tracks.forEach((t=>this.audioSources[t].start(0,i))),e&&(this.audioContext.resume(),requestAnimationFrame((()=>this.updateTimeSlider()))),this.isPlaying=e,document.getElementById("playPauseBtn").innerHTML=this.isPlaying?"&#10074;&#10074;":"&#9658;"}calculateScore(){if(!this.isAudioInitialized||!this.isAudioLoaded)return 0;let t=0;this.tracks.forEach((i=>{const e=this.playerSettings[i]||.5,s=this.faderToGain(e),o=1/this.randomGains[i],a=Math.abs(Math.log2(s)-Math.log2(o));t+=a}));const i=Math.max(0,100-t/this.tracks.length*25);return Math.round(i)}toggleComparisonMode(t){this.isComparisonMode=t,this.tracks.forEach((i=>{var e;const s=null===(e=document.getElementById(`${i}-fader`))||void 0===e?void 0:e.querySelector("input");t?(this.setTrackVolume(i,this.gainToFader(1/this.randomGains[i])),this.isSubmitted&&(s.value=this.gainToFader(1/this.randomGains[i]).toString())):(this.setTrackVolume(i,this.playerSettings[i]||.5),s.value=(this.playerSettings[i]||.5).toString()),s.disabled=t}))}initGame(){document.getElementById("playPauseBtn").addEventListener("click",(()=>this.togglePlayPause())),document.getElementById("masterVolume").addEventListener("input",(t=>this.setMasterVolume(parseFloat(t.target.value)))),document.getElementById("timeSlider").addEventListener("input",(t=>this.setPlaybackPosition(parseFloat(t.target.value)))),this.tracks.forEach((t=>{var i;(null===(i=document.getElementById(`${t}-fader`))||void 0===i?void 0:i.querySelector("input")).addEventListener("input",(i=>{if(!this.isAnswerMode){const e=parseFloat(i.target.value);this.setTrackVolume(t,e),this.playerSettings[t]=e}}))}));const t=document.getElementById("modeToggleCheckbox");t.addEventListener("change",(t=>{this.toggleComparisonMode(t.target.checked)})),document.getElementById("submitBtn").addEventListener("click",(()=>{const i=this.calculateScore(),e=document.getElementById("scoreDisplay");e.style.visibility="visible",e.textContent=i.toString(),document.getElementById("comparisonLabel").textContent="正確答案",this.isSubmitted=!0,t.checked=!1,this.toggleComparisonMode(!1)}))}}}})[156]()})();
//# sourceMappingURL=bundle.min.js.map