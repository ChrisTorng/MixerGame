(()=>{"use strict";class t extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){this.render(),this.setupEventListeners()}render(){const t=this.getAttribute("name")||"Track";this.shadowRoot.innerHTML=`\n      <style>\n        .fader {\n          display: flex;\n          flex-direction: column;\n          align-items: center;\n          margin: 0 10px 20px;\n        }\n        input[type="range"] {\n          writing-mode: vertical-lr;\n          direction: rtl;\n          width: 20px;\n          height: 150px;\n          margin: 0 10px;\n        }\n        label {\n          margin-top: 10px;\n          text-align: center;\n          color: white;\n        }\n      </style>\n      <div class="fader">\n        <input type="range" min="0" max="1" step="0.01" value="0.5" orient="vertical">\n        <label>${t}</label>\n      </div>\n    `,this.slider=this.shadowRoot.querySelector("input")}setupEventListeners(){this.slider.addEventListener("input",(t=>{const e=t.target;this.dispatchEvent(new CustomEvent("change",{detail:{value:parseFloat(e.value)},bubbles:!0,composed:!0}))}))}setDisabled(t){this.slider.disabled=t}setValue(t){this.slider.value=t.toString()}}customElements.get("volume-slider")||customElements.define("volume-slider",t);const e=t;var i=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{d(s.next(t))}catch(t){a(t)}}function r(t){try{d(s.throw(t))}catch(t){a(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}d((s=s.apply(t,e||[])).next())}))};new class{constructor(){this.isAudioInitialized=!1,this.isAudioLoaded=!1,this.isAnswerMode=!1,this.playerSettings={vocal:.5,guitar:.5,piano:.5,other:.5,bass:.5,drum:.5},this.isSubmitted=!1,this.isComparisonMode=!1,this.isPlaying=!1,this.startTime=0,this.pauseTime=0;const t="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname;this.tracksBaseUrl=t?"../UpLifeSongs/以斯拉 - 至高全能神的榮光":"../../UpLifeSongs/以斯拉 - 至高全能神的榮光",this.tracks=["vocal","guitar","piano","other","bass","drum"],this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioBuffers={},this.audioSources={},this.gainNodes={},this.analyserNodes={},this.masterGainNode=this.audioContext.createGain(),this.randomGains={},customElements.get("volume-slider")||customElements.define("volume-slider",e),this.initGame()}initAudio(){this.isAudioInitialized||(this.masterGainNode.connect(this.audioContext.destination),this.tracks.forEach((t=>{var e;this.gainNodes[t]=this.audioContext.createGain(),this.analyserNodes[t]=this.audioContext.createAnalyser(),this.gainNodes[t].connect(this.analyserNodes[t]),this.analyserNodes[t].connect(this.masterGainNode),this.randomGains[t]=Math.exp(Math.random()*Math.log(4))/2;const i=null===(e=document.getElementById(`${t}-fader`))||void 0===e?void 0:e.querySelector("input");i&&(i.value="0.5",this.setTrackVolume(t,.5))})),this.isAudioInitialized=!0)}loadAudio(){return i(this,void 0,void 0,(function*(){const t=document.getElementById("playPauseBtn");t.textContent="載入中",t.disabled=!0;try{yield Promise.all(this.tracks.map((t=>i(this,void 0,void 0,(function*(){const e=yield fetch(`${this.tracksBaseUrl}/${t}.mp3`),i=yield e.arrayBuffer();this.audioBuffers[t]=yield this.audioContext.decodeAudioData(i)}))))),this.isAudioLoaded=!0,t.innerHTML="&#9658;",t.disabled=!1,console.log("所有音軌已成功載入")}catch(e){console.error("載入音頻時發生錯誤:",e),t.textContent="載入失敗",t.disabled=!1}}))}createAudioSources(){this.tracks.forEach((t=>{this.audioSources[t]&&this.audioSources[t].disconnect(),this.audioSources[t]=this.audioContext.createBufferSource(),this.audioSources[t].buffer=this.audioBuffers[t],this.audioSources[t].connect(this.gainNodes[t]),this.audioSources[t].loop=!0}))}togglePlayPause(){if(!this.isAudioInitialized)return this.initAudio(),void this.loadAudio();this.isAudioLoaded&&(this.isPlaying?(this.audioContext.suspend(),this.pauseTime=this.audioContext.currentTime):(this.audioContext.resume(),this.audioSources[this.tracks[0]]&&this.audioSources[this.tracks[0]].buffer?this.startTime+=this.audioContext.currentTime-this.pauseTime:(this.createAudioSources(),this.startTime=this.audioContext.currentTime,this.tracks.forEach((t=>this.audioSources[t].start()))),requestAnimationFrame((()=>this.updateTimeSlider()))),this.isPlaying=!this.isPlaying,document.getElementById("playPauseBtn").innerHTML=this.isPlaying?"&#10074;&#10074;":"&#9658;")}updateTimeSlider(){if(!this.isPlaying)return;const t=(this.audioContext.currentTime-this.startTime)/this.audioBuffers[this.tracks[0]].duration*100;document.getElementById("timeSlider").value=t.toString(),requestAnimationFrame((()=>this.updateTimeSlider()))}setMasterVolume(t){this.isAudioInitialized&&this.masterGainNode.gain.setValueAtTime(t,this.audioContext.currentTime)}gainToFader(t){return Math.log(t/.25)/Math.log(16)}faderToGain(t){return.25*Math.pow(16,t)}setTrackVolume(t,e){if(!this.isAudioInitialized)return;const i=this.faderToGain(e);this.gainNodes[t].gain.setValueAtTime(i,this.audioContext.currentTime)}setPlaybackPosition(t){if(!this.isAudioInitialized||!this.isAudioLoaded)return;const e=t/100*this.audioBuffers[this.tracks[0]].duration,i=this.isPlaying;this.isPlaying&&this.audioContext.suspend(),this.createAudioSources(),this.startTime=this.audioContext.currentTime-e,this.tracks.forEach((t=>this.audioSources[t].start(0,e))),i&&(this.audioContext.resume(),requestAnimationFrame((()=>this.updateTimeSlider()))),this.isPlaying=i,document.getElementById("playPauseBtn").innerHTML=this.isPlaying?"&#10074;&#10074;":"&#9658;"}calculateScore(){if(!this.isAudioInitialized||!this.isAudioLoaded)return 0;let t=0;this.tracks.forEach((e=>{const i=this.playerSettings[e]||.5,s=this.faderToGain(i),n=1/this.randomGains[e],a=Math.abs(Math.log2(s)-Math.log2(n));t+=a}));const e=Math.max(0,100-t/this.tracks.length*25);return Math.round(e)}toggleComparisonMode(t){this.isComparisonMode=t,this.tracks.forEach((e=>{const i=document.getElementById(`${e}-fader`);t?(this.setTrackVolume(e,this.gainToFader(1/this.randomGains[e])),this.isSubmitted&&i.setValue(this.gainToFader(1/this.randomGains[e]))):(this.setTrackVolume(e,this.playerSettings[e]||.5),i.setValue(this.playerSettings[e]||.5)),i.setDisabled(t)}))}initGame(){document.getElementById("playPauseBtn").addEventListener("click",(()=>this.togglePlayPause())),document.getElementById("timeSlider").addEventListener("input",(t=>this.setPlaybackPosition(parseFloat(t.target.value)))),document.getElementById("master-volume").addEventListener("change",(t=>{const e=t;this.setMasterVolume(e.detail.value)})),this.tracks.forEach((t=>{document.getElementById(`${t}-fader`).addEventListener("change",(e=>{const i=e;if(!this.isAnswerMode){const e=i.detail.value;this.setTrackVolume(t,e),this.playerSettings[t]=e}}))}));const t=document.getElementById("modeToggleCheckbox");t.addEventListener("change",(t=>{this.toggleComparisonMode(t.target.checked)})),document.getElementById("submitBtn").addEventListener("click",(()=>{const e=this.calculateScore(),i=document.getElementById("scoreDisplay");i.style.visibility="visible",i.textContent=e.toString(),document.getElementById("comparisonLabel").textContent="正確答案",this.isSubmitted=!0,t.checked=!1,this.toggleComparisonMode(!1)}))}}})();
//# sourceMappingURL=bundle.min.js.map